{% extends 'base/base.html' %}
{% block title %}
{{ project_info.0 }} | {{ block.super }}
{% endblock title %}
{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css">
{% load static %}
<style>
    /* data table */
    .dataTables_length {
        text-align: right;
    }
    .page-item.active .page-link {
        background-color: rgb(228, 224, 224) !important;
        border: 1px solid rgb(228, 224, 224) ;
    }
    .page-link {
        color: black !important;
    }

    .dataTables_wrapper {
        background-color: white
    }

    #img-table {
        margin: 0 auto
    }

    #img-table_wrapper {
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }

    .oversight:hover {
        color: lightgrey;
    }

    .back:hover {
        color: lightgrey;
    }

    .btn-new {
        background-color: white;
        border: 1px solid #cccccc;
        color: black !important;
    }

    .ui-autocomplete { 
        z-index:2147483647; 
        max-height: 200px;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
        /* add padding to account for vertical scrollbar */
        padding-right: 20px;
    }

</style>
{% endblock head %}
{% block body %}
<div class="container content">
    <div class="row mb-2">
        <div class="col-2">
            <a class="text-gray back text-decoration-none align-middle" href="{% url 'project_overview' %}"><i class="fa fa-chevron-left"></i> è¿”å›è¨ˆç•«ç¸½è¦½</a>
        </div>
        <div class="col-10">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="title-dark p-0">{{ project_info.0 }}</h4>
                <div>
                    <a class="btn btn-outline-success" href="{% url 'edit_project_basic' pk %}"><i class="fa fa-xs fa-pencil"></i> è¨ˆç•«ç®¡ç†</a>
                    <a class="btn btn-outline-success" href="{% url 'edit_project_basic' pk %}"><i class="fas fa-file-csv"></i> ä¸‹è¼‰è³‡æ–™</a>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-2 bg-white shadow-sm">
            <div class="row">
                <p class="mt-3 d-flex justify-content-between">ç¯©é¸æ¢ä»¶
                    <button style="font-size: 14px" class="btn btn-light p-0 clear">æ¸…é™¤ ï¼</button>
                </p>
                <hr style='margin: auto; width: 90%'>
                <p class="mt-3 mb-1 d-flex justify-content-between">
                    <strong>ç‰©ç¨®</strong> 
                </p>
                <ul style="list-style: none">
                    <li>       
                        <label class="form-check-label">         
                        <input class="filter all" type="radio" name="species-filter" value="" checked>
                        å…¨éƒ¨
                        </label>
                    </li>
                    {% for i in species %}
                    <li>
                        <label class="form-check-label">
                        <input class="filter" type="radio" name="species-filter" value="{{ i }}">
                            {{ i }}
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <p class="mb-1"><strong>æ¨£å€</strong></p>
                <ul style="list-style: none">
                    <li>
                        <label class="form-check-label">             
                        <input class="filter all" type="radio" name="sa-filter" value="" checked>
                        å…¨éƒ¨
                        </label>
                    </li>
                    {% for i in studyarea %}
                    <li>
                        <label class="form-check-label">
                        <input class="filter" type="radio" name="sa-filter" value="{{ i.name }}">
                            {{ i.name }}
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <p class="mb-1"><strong>ç›¸æ©Ÿä½ç½®</strong></p>
                <ul style="list-style: none">
                    <li>
                        <label class="form-check-label">             
                        <input class="filter all" type="radio" name="deployment-filter" value="" checked>
                        å…¨éƒ¨
                        </label>
                    </li>
                    {% for i in deployment %}
                    <li>
                        <label class="form-check-label">
                        <input class="filter" type="radio" name="deployment-filter" value="{{ i.name }}">
                            {{ i.name }}
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <p class="mb-1"><strong>æ‹æ”æ—¥æœŸ</strong></p>
                <input type="text" class="mx-auto w-100 text-center mb-1 border-0" id="date" readonly>
                <div id="date-slider" class="w-75 mx-auto mb-5"></div>
            </div>
        </div>
        <div class="col-10">
            <table class="table bg-white table-borderless shadow-sm">
                <tr>
                    <td class="px-3">å§”è¾¦å–®ä½</td>
                    <td class="text-gray">{{ project_info.1 }}</td>
                </tr>
                <tr>
                    <td class="px-3">è¨ˆç•«ç·¨è™Ÿ</td>
                    <td class="text-gray">{{ project_info.2 }}</td>
                </tr>
                <tr>
                    <td class="px-3">è¨ˆç•«ä¸»æŒäºº</td>
                    <td class="text-gray">{{ project_info.3 }}</td>
                </tr>
                <tr>
                    <td class="px-3">è¨ˆç•«æ™‚é–“</td>
                    <td class="text-gray">{{ project_info.4 }} è‡³ {{ project_info.5 }}</td>
                </tr>
                <tr>
                    <td class="px-3">ç›¸æ©Ÿæ¨£é»é‹ä½œåŠç¼ºå¤±æ¯”ä¾‹</td>
                    <td><a class="oversight text-green text-decoration-none" href="">æŸ¥çœ‹</a></td>
                </tr>
            </table>
            <table class="table table-borderless w-100 px-3" id="img-table">
                <thead class="fw-bold title-dark">
                    <tr>
                        <td>æ¨£å€</td>
                        <td>ç›¸æ©Ÿä½ç½®</td>
                        <td>æª”å</td>
                        <td>æ‹æ”æ™‚é–“</td>
                        <td>ç‰©ç¨®</td>
                        <td>å¹´é½¡</td>
                        <td>æ€§åˆ¥</td>
                        <td>è§’æ³</td>
                        <td>å€‹é«”ID</td>
                        <td>å‚™è¨»</td>
                        <td>å½±åƒ</td>
                        <td>group_id</td>
                        <td>id</td>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body" id="modal-text">
                <div class="row my-3">
                    <div class="col-12" id="edit-image">
                    </div>
                </div>            
                <form novalidate action="{% url 'edit_image' pk %}" method="post" autocomplete="off" id="editForm">
                {% csrf_token %}
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">æ¨£å€</div>
                    <div class="col-9" id="edit-studyarea">
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">ç›¸æ©Ÿä½ç½®</div>
                    <div class="col-9" id="edit-deployment">
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">æª”å</div>
                    <div class="col-9" id="edit-filename">
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">æ‹æ”æ™‚é–“</div>
                    <div class="col-9" id="edit-datetime">
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">ç‰©ç¨®</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-species" type="text" name="species">
                        </div>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">å¹´é½¡</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-lifestage" type="text" name="lifestage">
                        </div>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">æ€§åˆ¥</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-sex" type="text" name="sex">
                        </div>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">è§’æ³</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-antler" type="text" name="antler">
                        </div>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">å€‹é«”ID</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-animal_id" type="text" name="animal_id">
                        </div>
                    </div>
                </div>                
                <div class="row my-3">
                    <div class="col-3 text-end my-auto ">å‚™è¨»</div>
                    <div class="col-9">
                        <div class="autocomplete">
                            <input class="form-control" id="edit-remarks" type="text" name="remarks">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="edit-group_id" name="group_id" value="">
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-outline-success" data-bs-dismiss="modal">å–æ¶ˆ</a>
                <a class="btn btn-orange" onClick="submitEdit()">å„²å­˜</a>
            </div>
        </div>
    </div>
</div>

{% endblock body %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
<script>
// autocomplete
var species = ['æ°´é¹¿','å±±ç¾Œ','ç¼çŒ´','å±±ç¾Š','é‡è±¬','é¼¬ç¾','ç™½é¼»å¿ƒ','é£ŸèŸ¹ç´','æ¾é¼ ','é£›é¼ ','é»ƒå–‰è²‚','é»ƒé¼ ç‹¼','å°é»ƒé¼ ç‹¼','éºé¦™è²“','é»‘ç†Š','çŸ³è™','ç©¿å±±ç”²','æ¢…èŠ±é¹¿','é‡å…”','è™è ', 'ç„¡æ³•è¾¨è­˜', 'ç©ºæ‹', 'å·¥ä½œç…§', 'æ¸¬è©¦', 'å°ç£å±±é·“é´£', 'å°ç£ç«¹é›', 'é»‘é•·å°¾é›‰', 'è—è…¹é·´', 'é»‘å† éº»é·º', 'ç’°é ¸é›‰', 'å±±é·¸', 'ç°æ—é´¿', 'é‡‘èƒŒé³©', 'ç é ¸æ–‘é³©', 'ç¿ ç¿¼é³©', 'é»ƒç—£è—ªçœ‰', 'å°ç£å™ªçœ‰', 'å°ç£ç´«å˜¯é¶‡', 'è™é¶‡', 'ç™½çœ‰é¶‡', 'ç™½è…¹é¶‡', 'èµ¤è…¹é¶‡', 'ç™½é ­é¶‡']
var antler = ['åˆèŒ¸','èŒ¸è§’ä¸€å°–','èŒ¸è§’ä¸€å²”äºŒå°–','èŒ¸è§’äºŒå²”ä¸‰å°–','èŒ¸è§’ä¸‰å²”å››å°–','ç¡¬è§’ä¸€å°–','ç¡¬è§’ä¸€å²”äºŒå°–','ç¡¬è§’äºŒå²”ä¸‰å°–','ç¡¬è§’ä¸‰å²”å››å°–','è§£è§’']
var sex = ['é›„æ€§','é›Œæ€§','ç„¡æ³•åˆ¤å®š']
var lifestage = ['æˆé«”','äºæˆé«”','å¹¼é«”','ç„¡æ³•åˆ¤å®š']

$('#edit-species').autocomplete({
    minLength: 0,
    source: function(request, response) {            
        var data = $.grep(species, function(value) {
            return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase();
        });            
        response(data);
    }
    }).focus(function () {
        $(this).autocomplete("search", "");
});

$('#edit-antler').autocomplete({
    minLength: 0,
    source: function(request, response) {            
        var data = $.grep(antler, function(value) {
            return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase();
        });            
        response(data);
    }
    }).focus(function () {
        $(this).autocomplete("search", "");
});

$('#edit-sex').autocomplete({
    minLength: 0,
    source: function(request, response) {            
        var data = $.grep(sex, function(value) {
            return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase();
        });            
        response(data);
    }
    }).focus(function () {
        $(this).autocomplete("search", "");
});

$('#edit-lifestage').autocomplete({
    minLength: 0,
    source: function(request, response) {            
        var data = $.grep(lifestage, function(value) {
            return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase();
        });            
        response(data);
    }
    }).focus(function () {
        $(this).autocomplete("search", "");
});


// datatable
let language_settings = {
    "decimal":        "",
    "emptyTable":     "æŸ¥ç„¡è³‡æ–™",
    "info":           "å…± _TOTAL_ ç­†",
    "infoEmpty":      "å…± 0 ç­†",
    "infoFiltered":   "",
    "infoPostFix":    "",
    "thousands":      ",",
    "lengthMenu":     "æ¯é é¡¯ç¤º _MENU_ ç­†",
    "loadingRecords": "è¼‰å…¥ä¸­...",
    "processing":     "è™•ç†ä¸­...",
    "search":         "æŸ¥è©¢ğŸ”",
    "zeroRecords":    "æŸ¥ç„¡ç¬¦åˆè³‡æ–™",
    "paginate": {
        "next":       "ä¸‹ä¸€é ",
        "previous":   "ä¸Šä¸€é "
    }
};

$(document).ready(function() {
    // date
    $("#date-slider").slider({
      range: true,
      min: new Date('{{ earliest_date }}').getTime() / 1000,
      max: new Date('{{ latest_date }}').getTime() / 1000,
      step: 86400,
      values: [ new Date('{{ earliest_date }}').getTime() / 1000, new Date('{{ latest_date }}').getTime() / 1000 ],
      slide: function( event, ui ) {
        $("#date").val((new Date(ui.values[ 0 ] *1000).toISOString().substring(0, 10)) + "è‡³" + 
        (new Date(ui.values[1]*1000)).toISOString().substring(0, 10));
      },
      stop: function( event, ui ) {
          console.log(table);
          $("#img-table").DataTable().draw()}
    });
    $("#date").val((new Date($("#date-slider").slider("values",0)*1000).toISOString().substring(0, 10)) + "è‡³" + 
    (new Date($("#date-slider").slider("values",1)*1000)).toISOString().substring(0, 10));

    // initalize datatable
    let table = $("#img-table").DataTable({
        dom:"<'row bg-gray'<'col-6'><'col-6 mb-2'l>>" +
            "<'row'<'col-sm-12'tr>>" +
            "<'row p-3'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        language: language_settings,
        ordering: false,
        processing: false,
        serverSide: true,
        searching: false,
        //scrollX: true,
        "initComplete": function (settings, json) {  
            $("#img-table").wrap("<div style='overflow:auto; width:100%;position:relative;'></div>");            
        },
        ajax: {
            type: "POST",
            url: "{% url 'data' %}",
            headers:{'X-CSRFToken':'{{ csrf_token }}'},
            data: function ( d ) {
                d.pk = "{{ pk }}";
                d.species = $("input[name=species-filter]:checked").val()
                d.sa =  $("input[name=sa-filter]:checked").val()
                d.deployment =  $("input[name=deployment-filter]:checked").val()
                d.start_date = (new Date($("#date-slider").slider("values",0)*1000)).toISOString().substring(0, 10)
                d.end_date = (new Date($("#date-slider").slider("values",1)*1000)).toISOString().substring(0, 10)
            }
        }, 
        order: [[0, "asc"]], 
        drawCallback:function(){
        // lazy loading for images
        var watcher = new IntersectionObserver(onEnterView);
        var lazyImages = document.querySelectorAll("img.lazy");
        for (let image of lazyImages) {
            watcher.observe(image); // é–‹å§‹ç›£è¦–
        }

        function onEnterView(entries, observer) {
            for (let entry of entries) {
                if (entry.isIntersecting) {
                    var img = entry.target;
                    img.setAttribute("src", img.dataset.src);
                    observer.unobserve(img); 
                }
            }
        }
        },
        columns: [
                    {data: "saname"},
                    {data: "dname"},
                    {data: "filename" },
                    {data: "datetime"},
                    {data: "species"},
                    {data: "lifestage"},
                    {data: "sex"},
                    {data: "antler"},
                    {data: "animal_id"},
                    {data: "remarks"},
                    {data: "file_url"},
                    {data: "group_id"},
                    {data: "id"},
                ], 
        columnDefs: [ 
            {
                "targets": [ 11,12 ],
                "visible": false
            }
        ],
    });

    $('.filter').on('click', function() {
        table.draw();
    });

    $('.clear').on('click', function() {
        $('.all').prop('checked', true);
        $("#date-slider").slider({
            range: true,
            min: new Date('{{ earliest_date }}').getTime() / 1000,
            max: new Date('{{ latest_date }}').getTime() / 1000,
            step: 86400,
            values: [ new Date('{{ earliest_date }}').getTime() / 1000, new Date('{{ latest_date }}').getTime() / 1000 ],
            slide: function( event, ui ) {
                $("#date").val((new Date(ui.values[ 0 ] *1000).toISOString().substring(0, 10)) + "è‡³" + 
                (new Date(ui.values[1]*1000)).toISOString().substring(0, 10));
            },
            stop: function( event, ui ) {
                $("#img-table").DataTable().draw()}
        });
        $("#date").val((new Date($("#date-slider").slider("values",0)*1000).toISOString().substring(0, 10)) + "è‡³" + 
        (new Date($("#date-slider").slider("values",1)*1000)).toISOString().substring(0, 10));
        table.draw();
    });

    // set permission: è¨ˆç•«ç¸½ç®¡ç†äºº/å€‹åˆ¥è¨ˆç•«æ‰¿è¾¦äºº/ç³»çµ±ç®¡ç†å“¡
    {% if edit %}
        $('#img-table').on('click', 'tbody tr', function () {
        var row = table.row($(this)).data();
        $('#edit-species').val(row['species'])
        $('#edit-animal_id').val(row['animal_id'])
        $('#edit-lifestage').val(row['lifestage'])
        $('#edit-sex').val(row['sex'])
        $('#edit-remarks').val(row['remarks'])
        $('#edit-group_id').val(row['group_id'])
        $('#edit-image').html(row['file_url'])
        $('#edit-image .img').attr('src', $('#edit-image .img').data('src')).addClass('w-100').css("height", "");
        $('#edit-studyarea').html(row['saname'])
        $('#edit-deployment').html(row['dname'])
        $('#edit-filename').html(row['filename'])
        $('#edit-datetime').html(row['datetime'])
        $('#editModal').modal('show');
        });
    {% endif %}

});


function submitEdit(){        
    $.ajax({
        data: $('#editForm').serialize(),
        type: "POST",
        url: "{% url 'edit_image' pk %}",
        success: function(data) {
            console.log(data);
    }})
}
</script>
{% endblock script %}